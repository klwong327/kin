<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transit Time Calculator</title>
    <style>
        :root {
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: rgba(50, 184, 198, 1);
                --color-primary-hover: rgba(45, 166, 178, 1);
                --color-primary-active: rgba(41, 150, 161, 1);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-card-border: rgba(119, 124, 124, 0.2);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--color-surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .setup-warning {
            background: rgba(255, 200, 87, 0.15);
            border: 1px solid rgba(255, 200, 87, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .setup-warning h3 {
            color: #d97706;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text);
            font-size: 14px;
        }

        select, input[type="time"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--color-surface);
            color: var(--color-text);
            transition: border-color 0.2s;
        }

        select:focus, input[type="time"]:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .advance-time-group {
            margin-bottom: 20px;
        }

        .advance-time-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .advance-btn {
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .advance-btn:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-teal-500-rgb), 0.1);
        }

        .advance-btn.selected {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-hover);
        }

        .btn:active {
            background: var(--color-primary-active);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results {
            margin-top: 24px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--color-text-secondary);
        }

        .option {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .option-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }

        .option-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-mtr {
            background: rgba(33, 128, 141, 0.15);
            color: var(--color-primary);
        }

        .badge-bus {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .option-details {
            font-size: 14px;
            color: var(--color-text-secondary);
            line-height: 1.8;
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .time-label {
            font-weight: 500;
        }

        .time-value {
            font-weight: 600;
            color: var(--color-text);
        }

        .error {
            background: rgba(192, 21, 47, 0.1);
            border: 1px solid rgba(192, 21, 47, 0.3);
            color: var(--color-red-500);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .steps {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--color-card-border);
        }

        .step {
            padding: 8px 0;
            font-size: 13px;
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöå Transit Time Calculator</h1>

        <div class="setup-warning">
            <h3>‚ö†Ô∏è Setup Required</h3>
            <p>You need to add your Google Maps API key in the code. Get one at: <a href="https://console.cloud.google.com/google/maps-apis" target="_blank">Google Maps Platform</a>. Enable the "Directions API" in your Google Cloud Console.</p>
        </div>

        <div class="form-group">
            <label>Select Workplace</label>
            <select id="workplace">
                <option value="cxcity">1Ô∏è‚É£ CX City</option>
                <option value="airport">2Ô∏è‚É£ Airport</option>
            </select>
        </div>

        <div class="form-group">
            <label>Report Duty Time ‚úàÔ∏è</label>
            <input type="time" id="dutyTime" value="11:00">
            <small style="color: var(--color-text-secondary); display: block; margin-top: 4px;">What time do you need to report for duty?</small>
        </div>

        <div class="advance-time-group">
            <label>Advance Time Choose</label>
            <div class="advance-time-buttons">
                <button class="advance-btn" data-minutes="15">15 mins</button>
                <button class="advance-btn" data-minutes="20">20 mins</button>
                <button class="advance-btn" data-minutes="25">25 mins</button>
                <button class="advance-btn selected" data-minutes="30">30 mins</button>
                <button class="advance-btn" data-minutes="35">35 mins</button>
                <button class="advance-btn" data-minutes="40">40 mins</button>
            </div>
            <small style="color: var(--color-text-secondary); display: block; margin-top: 8px;">How early should you arrive before duty time?</small>
        </div>

        <button class="btn" onclick="calculateTransit()">Calculate When to Leave</button>

        <div id="results" class="results"></div>

        <!-- Airport Info Section -->
        <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid var(--color-border);">
            <h2 style="font-size: 20px; margin-bottom: 16px;">‚úàÔ∏è Airport Information Lookup</h2>
            
            <div class="form-group">
                <label>Enter Airport Code (IATA)</label>
                <input type="text" id="airportCode" placeholder="e.g., JFK, LAX, HKG" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px; background: var(--color-surface); color: var(--color-text); text-transform: uppercase;">
                <small style="color: var(--color-text-secondary); display: block; margin-top: 4px;">Enter 3-letter IATA airport code</small>
            </div>

            <button class="btn" onclick="lookupAirport()">Search Airport</button>

            <div id="airportResults" style="margin-top: 16px;"></div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBD5iVr11BID7B1477W8W2tlfi0O0ac1KQ&libraries=places"></script>
    <script>
        // Hardcoded home location (hidden from user)
        const HOME_LOCATION = {lat: 22.316910, lng: 114.163717};

        // Workplace locations
        const WORKPLACES = {
            cxcity: {lat: 22.298189, lng: 113.934747, name: 'CX City'},
            airport: {lat: 22.316076, lng: 113.936037, name: 'Airport'}
        };

        // Your Google Maps API key
        const API_KEY = 'AIzaSyBD5iVr11BID7B1477W8W2tlfi0O0ac1KQ';

        let selectedAdvanceMinutes = 30; // Default

        // Handle advance time button selection
        document.querySelectorAll('.advance-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.advance-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedAdvanceMinutes = parseInt(this.dataset.minutes);
            });
        });

        async function calculateTransit() {
            const workplace = document.getElementById('workplace').value;
            const dutyTime = document.getElementById('dutyTime').value;
            const resultsDiv = document.getElementById('results');

            if (!dutyTime) {
                resultsDiv.innerHTML = '<div class="error">Please enter a duty time.</div>';
                return;
            }

            if (API_KEY === 'YOUR_API_KEY_HERE' || typeof google === 'undefined') {
                resultsDiv.innerHTML = '<div class="error">Please add your Google Maps API key in the code (line 12 and in script src tag).</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">‚è≥ Calculating transit routes...</div>';

            try {
                // Calculate target arrival time (duty time minus advance time)
                const targetArrivalTime = calculateTargetArrivalTime(dutyTime, selectedAdvanceMinutes);
                
                const destination = WORKPLACES[workplace];

                // Get two transit options based on workplace
                let options;
                if (workplace === 'cxcity') {
                    options = await getCXCityOptions(targetArrivalTime, destination);
                } else {
                    options = await getAirportOptions(targetArrivalTime, destination);
                }

                displayResults(options, dutyTime, selectedAdvanceMinutes);
            } catch (error) {
                console.error('Transit calculation error:', error);
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}<br><small>Check browser console for details.</small></div>`;
            }
        }

        function calculateTargetArrivalTime(dutyTime, advanceMinutes) {
            const [hours, minutes] = dutyTime.split(':').map(Number);
            const dutyDate = new Date();
            dutyDate.setHours(hours, minutes, 0, 0);
            
            // Subtract advance time
            const targetDate = new Date(dutyDate.getTime() - advanceMinutes * 60000);
            
            return targetDate;
        }

        async function getCXCityOptions(arrivalTime, destination) {
            const tungChungBusTerminus = {lat: 22.289547245983123, lng: 113.94052342186916};
            const options = [];

            try {
                // Option 1: MTR to Tung Chung + S/E bus from Tung Chung Station Bus Terminus
                const mtrToBusOption = await getMultiLegRoute(
                    HOME_LOCATION,
                    tungChungBusTerminus,
                    null,
                    destination,
                    arrivalTime,
                    ['RAIL', 'SUBWAY'],
                    ['BUS']
                );
                if (mtrToBusOption) {
                    options.push({ 
                        ...mtrToBusOption, 
                        title: 'Option 1: MTR ‚Üí Tung Chung ‚Üí S/E Bus', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('MTR + Bus option failed:', e);
            }

            try {
                // Option 2: Direct E or A bus from home (no transfers)
                const directBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS'],
                    true // direct route only
                );
                if (directBusOption) {
                    options.push({ 
                        ...directBusOption, 
                        title: 'Option 2: Direct E/A Bus from Home', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Direct bus option failed:', e);
            }

            try {
                // Option 3: Alternative MTR + Bus route
                const altMTROption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS', 'RAIL', 'SUBWAY']
                );
                if (altMTROption && options.length < 4) {
                    options.push({ 
                        ...altMTROption, 
                        title: 'Option 3: MTR + Transit Bus', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('Alternative MTR option failed:', e);
            }

            try {
                // Option 4: Any other bus route
                const altBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS']
                );
                if (altBusOption && options.length < 4) {
                    options.push({ 
                        ...altBusOption, 
                        title: 'Option 4: Alternative Bus Route', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Alternative bus option failed:', e);
            }

            // Return up to 4 options
            return options.slice(0, 4);
        }

        async function getAirportOptions(arrivalTime, destination) {
            const olympicStation = {lat: 22.318100, lng: 114.159800};
            const tsingYiStation = {lat: 22.357400, lng: 114.108600};
            const options = [];

            try {
                // Option 1: Home ‚Üí Olympic (Walk/MTR) ‚Üí Tsing Yi (MTR) ‚Üí Airport (AEL)
                // Break into segments since Google doesn't recognize full 3-leg transit well
                const aelOption = await getAirportExpressRoute(
                    HOME_LOCATION,
                    olympicStation,
                    tsingYiStation,
                    destination,
                    arrivalTime
                );
                if (aelOption) {
                    options.push({ 
                        ...aelOption, 
                        title: 'Option 1: MTR ‚Üí Olympic ‚Üí AEL from Tsing Yi', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('AEL option failed:', e);
            }

            try {
                // Option 2: Direct E or A bus from home (no transfers)
                const directBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS'],
                    true // direct route only
                );
                if (directBusOption) {
                    options.push({ 
                        ...directBusOption, 
                        title: 'Option 2: Direct E/A Bus from Home', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Direct bus option failed:', e);
            }

            try {
                // Option 3: Alternative MTR + Bus route
                const altMTROption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS', 'RAIL', 'SUBWAY']
                );
                if (altMTROption && options.length < 4) {
                    options.push({ 
                        ...altMTROption, 
                        title: 'Option 3: MTR + Transit Bus', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('Alternative MTR option failed:', e);
            }

            try {
                // Option 4: Any other bus route
                const altBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS']
                );
                if (altBusOption && options.length < 4) {
                    options.push({ 
                        ...altBusOption, 
                        title: 'Option 4: Alternative Bus Route', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Alternative bus option failed:', e);
            }

            // Return up to 4 options
            return options.slice(0, 4);
        }

        async function getAirportExpressRoute(origin, olympicStation, tsingYiStation, destination, arrivalTime) {
            const directionsService = new google.maps.DirectionsService();
            
            // Simplified approach: Home ‚Üí Tsing Yi ‚Üí Airport
            // This better matches actual travel patterns (MTR to Tsing Yi, then AEL)
            
            // Step 1: Get Airport Express timing from Tsing Yi to Airport
            const aelRequest = {
                origin: new google.maps.LatLng(tsingYiStation.lat, tsingYiStation.lng),
                destination: new google.maps.LatLng(destination.lat, destination.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: [google.maps.TransitMode.RAIL],
                    arrivalTime: arrivalTime
                }
            };

            const aelResult = await new Promise((resolve, reject) => {
                directionsService.route(aelRequest, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`Airport Express route failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const aelLeg = aelResult.routes[0].legs[0];
            const tsingYiDepartureTime = new Date(arrivalTime.getTime() - aelLeg.duration.value * 1000);

            // Step 2: Get MTR from home area to Tsing Yi (via Olympic if needed)
            const mtrRequest = {
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(tsingYiStation.lat, tsingYiStation.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: [google.maps.TransitMode.SUBWAY, google.maps.TransitMode.RAIL],
                    arrivalTime: tsingYiDepartureTime
                }
            };

            const mtrResult = await new Promise((resolve, reject) => {
                directionsService.route(mtrRequest, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`MTR to Tsing Yi route failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const mtrLeg = mtrResult.routes[0].legs[0];

            // Calculate total duration
            const totalDurationSeconds = mtrLeg.duration.value + aelLeg.duration.value;
            const totalDurationText = Math.floor(totalDurationSeconds / 60) + ' mins';

            // Combine steps
            const allSteps = [
                ...mtrLeg.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                })),
                ...aelLeg.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                }))
            ];

            return {
                duration: totalDurationText,
                departureTime: mtrLeg.departure_time.text,
                arrivalTime: aelLeg.arrival_time.text,
                steps: allSteps
            };
        }

        async function getDirections(origin, destination, arrivalTime, mode, transitModes, directOnly = false) {
            const directionsService = new google.maps.DirectionsService();
            
            const request = {
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(destination.lat, destination.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: transitModes.map(m => google.maps.TransitMode[m]),
                    arrivalTime: arrivalTime
                },
                provideRouteAlternatives: true
            };

            return new Promise((resolve, reject) => {
                directionsService.route(request, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK || !result.routes || result.routes.length === 0) {
                        console.error('Directions API error:', status, result);
                        reject(new Error(`No routes found (${status})`));
                        return;
                    }

                    // If directOnly is true, filter for routes with minimal transfers
                    let route;
                    if (directOnly) {
                        // Find route with fewest transfers (ideally 1 bus)
                        const directRoutes = result.routes.filter(r => {
                            const transitSteps = r.legs[0].steps.filter(s => s.transit);
                            return transitSteps.length === 1;
                        });
                        route = directRoutes[0] || result.routes[0];
                    } else {
                        route = result.routes[0];
                    }

                    const leg = route.legs[0];

                    resolve({
                        duration: leg.duration.text,
                        departureTime: leg.departure_time.text,
                        arrivalTime: leg.arrival_time.text,
                        steps: leg.steps.map(step => ({
                            instruction: step.instructions.replace(/<[^>]*>/g, ''),
                            mode: step.travel_mode,
                            transitDetails: step.transit
                        }))
                    });
                });
            });
        }

        async function getMultiLegRoute(origin, waypoint1, waypoint2, destination, arrivalTime, transitModes1, transitModes2) {
            const directionsService = new google.maps.DirectionsService();
            
            // If waypoint2 exists, this is a 3-leg journey (Home ‚Üí Waypoint1 ‚Üí Waypoint2 ‚Üí Destination)
            // Otherwise, it's a 2-leg journey (Home ‚Üí Waypoint ‚Üí Destination)
            const isThreeLeg = waypoint2 !== undefined && waypoint2 !== null;
            
            if (isThreeLeg) {
                // Three-leg route: Home ‚Üí Olympic ‚Üí Tsing Yi ‚Üí Airport
                
                // Leg 3: Tsing Yi to Airport (we know arrival time)
                const leg3Request = {
                    origin: new google.maps.LatLng(waypoint2.lat, waypoint2.lng),
                    destination: new google.maps.LatLng(destination.lat, destination.lng),
                    travelMode: google.maps.TravelMode.TRANSIT,
                    transitOptions: {
                        modes: transitModes2.map(m => google.maps.TransitMode[m]),
                        arrivalTime: arrivalTime
                    }
                };

                const leg3Result = await new Promise((resolve, reject) => {
                    directionsService.route(leg3Request, (result, status) => {
                        if (status !== google.maps.DirectionsStatus.OK) {
                            reject(new Error(`Leg 3 failed: ${status}`));
                            return;
                        }
                        resolve(result);
                    });
                });

                const leg3 = leg3Result.routes[0].legs[0];
                const waypoint2DepartureTime = new Date(arrivalTime.getTime() - leg3.duration.value * 1000);

                // Leg 2: Olympic to Tsing Yi
                const leg2Request = {
                    origin: new google.maps.LatLng(waypoint1.lat, waypoint1.lng),
                    destination: new google.maps.LatLng(waypoint2.lat, waypoint2.lng),
                    travelMode: google.maps.TravelMode.TRANSIT,
                    transitOptions: {
                        modes: transitModes1.map(m => google.maps.TransitMode[m]),
                        arrivalTime: waypoint2DepartureTime
                    }
                };

                const leg2Result = await new Promise((resolve, reject) => {
                    directionsService.route(leg2Request, (result, status) => {
                        if (status !== google.maps.DirectionsStatus.OK) {
                            reject(new Error(`Leg 2 failed: ${status}`));
                            return;
                        }
                        resolve(result);
                    });
                });

                const leg2 = leg2Result.routes[0].legs[0];
                const waypoint1DepartureTime = new Date(waypoint2DepartureTime.getTime() - leg2.duration.value * 1000);

                // Leg 1: Home to Olympic
                const leg1Request = {
                    origin: new google.maps.LatLng(origin.lat, origin.lng),
                    destination: new google.maps.LatLng(waypoint1.lat, waypoint1.lng),
                    travelMode: google.maps.TravelMode.TRANSIT,
                    transitOptions: {
                        modes: transitModes1.map(m => google.maps.TransitMode[m]),
                        arrivalTime: waypoint1DepartureTime
                    }
                };

                const leg1Result = await new Promise((resolve, reject) => {
                    directionsService.route(leg1Request, (result, status) => {
                        if (status !== google.maps.DirectionsStatus.OK) {
                            reject(new Error(`Leg 1 failed: ${status}`));
                            return;
                        }
                        resolve(result);
                    });
                });

                const leg1 = leg1Result.routes[0].legs[0];

                // Calculate total duration
                const totalDurationSeconds = leg1.duration.value + leg2.duration.value + leg3.duration.value;
                const totalDurationText = Math.floor(totalDurationSeconds / 60) + ' mins';

                // Combine steps
                const allSteps = [
                    ...leg1.steps.map(step => ({
                        instruction: step.instructions.replace(/<[^>]*>/g, ''),
                        mode: step.travel_mode,
                        transitDetails: step.transit
                    })),
                    ...leg2.steps.map(step => ({
                        instruction: step.instructions.replace(/<[^>]*>/g, ''),
                        mode: step.travel_mode,
                        transitDetails: step.transit
                    })),
                    ...leg3.steps.map(step => ({
                        instruction: step.instructions.replace(/<[^>]*>/g, ''),
                        mode: step.travel_mode,
                        transitDetails: step.transit
                    }))
                ];

                return {
                    duration: totalDurationText,
                    departureTime: leg1.departure_time.text,
                    arrivalTime: leg3.arrival_time.text,
                    steps: allSteps
                };
            }
            
            // Two-leg route (original logic for CX City)
            const finalDestination = destination || waypoint2;
            
            // Get route from waypoint to destination first (we know arrival time)
            const leg2Request = {
                origin: new google.maps.LatLng(waypoint1.lat, waypoint1.lng),
                destination: new google.maps.LatLng(finalDestination.lat, finalDestination.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: transitModes2.map(m => google.maps.TransitMode[m]),
                    arrivalTime: arrivalTime
                }
            };

            const leg2Result = await new Promise((resolve, reject) => {
                directionsService.route(leg2Request, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`Leg 2 failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const leg2 = leg2Result.routes[0].legs[0];
            
            // Calculate departure time from waypoint (to arrive on time)
            const waypointDepartureTime = new Date(arrivalTime.getTime() - leg2.duration.value * 1000);

            // Get route from origin to waypoint (arriving at waypoint departure time)
            const leg1Request = {
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(waypoint1.lat, waypoint1.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: transitModes1.map(m => google.maps.TransitMode[m]),
                    arrivalTime: waypointDepartureTime
                }
            };

            const leg1Result = await new Promise((resolve, reject) => {
                directionsService.route(leg1Request, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`Leg 1 failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const leg1 = leg1Result.routes[0].legs[0];

            // Calculate total duration
            const totalDurationSeconds = leg1.duration.value + leg2.duration.value;
            const totalDurationText = Math.floor(totalDurationSeconds / 60) + ' mins';

            // Combine steps
            const allSteps = [
                ...leg1.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                })),
                ...leg2.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                }))
            ];

            return {
                duration: totalDurationText,
                departureTime: leg1.departure_time.text,
                arrivalTime: leg2.arrival_time.text,
                steps: allSteps
            };
        }

        function displayResults(options, dutyTime, advanceMinutes) {
            const resultsDiv = document.getElementById('results');
            
            let html = '<h2 style="margin-bottom: 16px;">Transit Options</h2>';
            html += `<p style="color: var(--color-text-secondary); margin-bottom: 16px;">Report duty at ${dutyTime}, arriving ${advanceMinutes} mins early</p>`;

            options.forEach(option => {
                html += `
                    <div class="option">
                        <div class="option-header">
                            <div class="option-title">${option.title}</div>
                            <div class="option-badge badge-${option.badge}">${option.duration}</div>
                        </div>
                        <div class="option-details">
                            <div class="time-row">
                                <span class="time-label">üè† Leave Home:</span>
                                <span class="time-value">${option.departureTime}</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üè¢ Arrive Company:</span>
                                <span class="time-value">${option.arrivalTime}</span>
                            </div>
                        </div>
                        <div class="steps">
                            ${option.steps.map(step => {
                                let stepText = step.instruction;
                                if (step.transitDetails) {
                                    const transit = step.transitDetails;
                                    stepText = `${transit.line.vehicle.name || 'Transit'}: ${transit.line.short_name || transit.line.name || ''} to ${transit.headsign || ''}`;
                                }
                                return `<div class="step">‚Ä¢ ${stepText}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Airport lookup functionality
        async function lookupAirport() {
            const airportCode = document.getElementById('airportCode').value.trim().toUpperCase();
            const resultsDiv = document.getElementById('airportResults');

            if (!airportCode || airportCode.length !== 3) {
                resultsDiv.innerHTML = '<div class="error">Please enter a valid 3-letter airport code.</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">üîç Looking up airport information...</div>';

            try {
                // Fetch airport data from AirLabs API (free tier)
                const airportResponse = await fetch(`https://airlabs.co/api/v9/airports?iata_code=${airportCode}&api_key=YOUR_AIRLABS_API_KEY`);
                
                if (!airportResponse.ok) {
                    throw new Error('Airport not found or API error');
                }

                const airportData = await airportResponse.json();
                
                if (!airportData.response || airportData.response.length === 0) {
                    resultsDiv.innerHTML = '<div class="error">Airport code not found. Please check and try again.</div>';
                    return;
                }

                const airport = airportData.response[0];
                
                // Get weather data from Open-Meteo (free, no API key needed)
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${airport.lat}&longitude=${airport.lng}&current=temperature_2m,weather_code&timezone=auto`
                );
                
                const weatherData = await weatherResponse.json();
                
                // Calculate time difference with HKT (GMT+8)
                const airportTimezone = airport.timezone;
                const hktOffset = 8 * 60; // HKT is GMT+8 in minutes
                
                // Get current time in airport's timezone
                const now = new Date();
                const airportTime = new Date(now.toLocaleString('en-US', { timeZone: airportTimezone }));
                const hktTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }));
                
                // Calculate time difference in hours
                const timeDiff = (airportTime.getTime() - hktTime.getTime()) / (1000 * 60 * 60);
                const timeDiffText = timeDiff >= 0 ? `+${timeDiff.toFixed(1)}` : timeDiff.toFixed(1);
                
                // Weather code to description mapping (WMO codes)
                const weatherDescriptions = {
                    0: '‚òÄÔ∏è Clear sky',
                    1: 'üå§Ô∏è Mainly clear',
                    2: '‚õÖ Partly cloudy',
                    3: '‚òÅÔ∏è Overcast',
                    45: 'üå´Ô∏è Foggy',
                    48: 'üå´Ô∏è Depositing rime fog',
                    51: 'üå¶Ô∏è Light drizzle',
                    53: 'üå¶Ô∏è Moderate drizzle',
                    55: 'üåßÔ∏è Dense drizzle',
                    61: 'üåßÔ∏è Slight rain',
                    63: 'üåßÔ∏è Moderate rain',
                    65: 'üåßÔ∏è Heavy rain',
                    71: 'üå®Ô∏è Slight snow',
                    73: 'üå®Ô∏è Moderate snow',
                    75: 'üå®Ô∏è Heavy snow',
                    77: '‚ùÑÔ∏è Snow grains',
                    80: 'üå¶Ô∏è Slight rain showers',
                    81: 'üåßÔ∏è Moderate rain showers',
                    82: 'üåßÔ∏è Violent rain showers',
                    85: 'üå®Ô∏è Slight snow showers',
                    86: 'üå®Ô∏è Heavy snow showers',
                    95: '‚õàÔ∏è Thunderstorm',
                    96: '‚õàÔ∏è Thunderstorm with slight hail',
                    99: '‚õàÔ∏è Thunderstorm with heavy hail'
                };

                const weatherCode = weatherData.current.weather_code;
                const weatherDesc = weatherDescriptions[weatherCode] || 'üå§Ô∏è Unknown';
                const temperature = weatherData.current.temperature_2m;

                // Display results
                let html = `
                    <div class="option">
                        <div class="option-header">
                            <div class="option-title">${airport.name} (${airportCode})</div>
                            <div class="option-badge badge-mtr">${airport.country_code}</div>
                        </div>
                        <div class="option-details">
                            <div class="time-row">
                                <span class="time-label">üåç Country:</span>
                                <span class="time-value">${airport.country_code}</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üèôÔ∏è City:</span>
                                <span class="time-value">${airport.city || 'N/A'}</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üïê Local Time:</span>
                                <span class="time-value">${airportTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">‚è∞ Time Diff from HKT:</span>
                                <span class="time-value">${timeDiffText} hours</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üå°Ô∏è Temperature:</span>
                                <span class="time-value">${temperature}¬∞C</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üå§Ô∏è Weather:</span>
                                <span class="time-value">${weatherDesc}</span>
                            </div>
                        </div>
                    </div>
                `;

                resultsDiv.innerHTML = html;

            } catch (error) {
                console.error('Airport lookup error:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <strong>Error fetching airport data</strong><br>
                        <small>Note: This feature requires a free API key from <a href="https://airlabs.co" target="_blank" style="color: var(--color-primary);">AirLabs.co</a>. 
                        Please add your API key in the code (search for YOUR_AIRLABS_API_KEY).</small><br>
                        <small style="margin-top: 8px; display: block;">Weather data from Open-Meteo is free and requires no API key.</small>
                    </div>
                `;
            }
        }

        // Allow Enter key to trigger airport search
        document.getElementById('airportCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupAirport();
            }
        });
    </script>
</body>
</html>
