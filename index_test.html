<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transit Time Calculator</title>
    <style>
        :root {
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: rgba(50, 184, 198, 1);
                --color-primary-hover: rgba(45, 166, 178, 1);
                --color-primary-active: rgba(41, 150, 161, 1);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-card-border: rgba(119, 124, 124, 0.2);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--color-surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .setup-warning {
            background: rgba(255, 200, 87, 0.15);
            border: 1px solid rgba(255, 200, 87, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .setup-warning h3 {
            color: #d97706;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text);
            font-size: 14px;
        }

        select, input[type="time"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--color-surface);
            color: var(--color-text);
            transition: border-color 0.2s;
        }

        select:focus, input[type="time"]:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .advance-time-group {
            margin-bottom: 20px;
        }

        .advance-time-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .advance-btn {
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .advance-btn:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-teal-500-rgb), 0.1);
        }

        .advance-btn.selected {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-hover);
        }

        .btn:active {
            background: var(--color-primary-active);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results {
            margin-top: 24px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--color-text-secondary);
        }

        .option {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .option-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }

        .option-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-mtr {
            background: rgba(33, 128, 141, 0.15);
            color: var(--color-primary);
        }

        .badge-bus {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .option-details {
            font-size: 14px;
            color: var(--color-text-secondary);
            line-height: 1.8;
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .time-label {
            font-weight: 500;
        }

        .time-value {
            font-weight: 600;
            color: var(--color-text);
        }

        .error {
            background: rgba(192, 21, 47, 0.1);
            border: 1px solid rgba(192, 21, 47, 0.3);
            color: var(--color-red-500);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .steps {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--color-card-border);
        }

        .step {
            padding: 8px 0;
            font-size: 13px;
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöå Transit Time Calculator</h1>

        <div class="setup-warning">
            <h3>‚ö†Ô∏è Setup Required</h3>
            <p>You need to add your Google Maps API key in the code. Get one at: <a href="https://console.cloud.google.com/google/maps-apis" target="_blank">Google Maps Platform</a>. Enable the "Directions API" in your Google Cloud Console.</p>
        </div>

        <div class="form-group">
            <label>Select Workplace</label>
            <select id="workplace">
                <option value="cxcity">1Ô∏è‚É£ CX City</option>
                <option value="airport">2Ô∏è‚É£ Airport</option>
            </select>
        </div>

        <div class="form-group">
            <label>Report Duty Time ‚úàÔ∏è</label>
            <input type="time" id="dutyTime" value="11:00">
            <small style="color: var(--color-text-secondary); display: block; margin-top: 4px;">What time do you need to report for duty?</small>
        </div>

        <div class="advance-time-group">
            <label>Advance Time Choose</label>
            <div class="advance-time-buttons">
                <button class="advance-btn" data-minutes="15">15 mins</button>
                <button class="advance-btn" data-minutes="20">20 mins</button>
                <button class="advance-btn" data-minutes="25">25 mins</button>
                <button class="advance-btn selected" data-minutes="30">30 mins</button>
                <button class="advance-btn" data-minutes="35">35 mins</button>
                <button class="advance-btn" data-minutes="40">40 mins</button>
            </div>
            <small style="color: var(--color-text-secondary); display: block; margin-top: 8px;">How early should you arrive before duty time?</small>
        </div>

        <button class="btn" onclick="calculateTransit()">Calculate When to Leave</button>

        <div id="results" class="results"></div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBD5iVr11BID7B1477W8W2tlfi0O0ac1KQ&libraries=places"></script>
    <script>
        // Hardcoded home location (hidden from user)
        const HOME_LOCATION = {lat: 22.316910, lng: 114.163717};

        // Workplace locations
        const WORKPLACES = {
            cxcity: {lat: 22.298189, lng: 113.934747, name: 'CX City'},
            airport: {lat: 22.316076, lng: 113.936037, name: 'Airport'}
        };

        // Your Google Maps API key
        const API_KEY = 'AIzaSyBD5iVr11BID7B1477W8W2tlfi0O0ac1KQ';

        let selectedAdvanceMinutes = 30; // Default

        // Handle advance time button selection
        document.querySelectorAll('.advance-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.advance-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedAdvanceMinutes = parseInt(this.dataset.minutes);
            });
        });

        async function calculateTransit() {
            const workplace = document.getElementById('workplace').value;
            const dutyTime = document.getElementById('dutyTime').value;
            const resultsDiv = document.getElementById('results');

            if (!dutyTime) {
                resultsDiv.innerHTML = '<div class="error">Please enter a duty time.</div>';
                return;
            }

            if (API_KEY === 'YOUR_API_KEY_HERE' || typeof google === 'undefined') {
                resultsDiv.innerHTML = '<div class="error">Please add your Google Maps API key in the code (line 12 and in script src tag).</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">‚è≥ Calculating transit routes...</div>';

            try {
                // Calculate target arrival time (duty time minus advance time)
                const targetArrivalTime = calculateTargetArrivalTime(dutyTime, selectedAdvanceMinutes);
                
                const destination = WORKPLACES[workplace];

                // Get two transit options based on workplace
                let options;
                if (workplace === 'cxcity') {
                    options = await getCXCityOptions(targetArrivalTime, destination);
                } else {
                    options = await getAirportOptions(targetArrivalTime, destination);
                }

                displayResults(options, dutyTime, selectedAdvanceMinutes);
            } catch (error) {
                console.error('Transit calculation error:', error);
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}<br><small>Check browser console for details.</small></div>`;
            }
        }

        function calculateTargetArrivalTime(dutyTime, advanceMinutes) {
            const [hours, minutes] = dutyTime.split(':').map(Number);
            const dutyDate = new Date();
            dutyDate.setHours(hours, minutes, 0, 0);
            
            // Subtract advance time
            const targetDate = new Date(dutyDate.getTime() - advanceMinutes * 60000);
            
            return targetDate;
        }

        async function getCXCityOptions(arrivalTime, destination) {
            const tungChungBusTerminus = {lat: 22.289547245983123, lng: 113.94052342186916};
            const options = [];

            try {
                // Option 1: MTR to Tung Chung + S/E bus from Tung Chung Station Bus Terminus
                const mtrToBusOption = await getMultiLegRoute(
                    HOME_LOCATION,
                    tungChungBusTerminus,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['RAIL', 'SUBWAY'],
                    ['BUS']
                );
                if (mtrToBusOption) {
                    options.push({ 
                        ...mtrToBusOption, 
                        title: 'Option 1: MTR ‚Üí Tung Chung ‚Üí S/E Bus', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('MTR + Bus option failed:', e);
            }

            try {
                // Option 2: Direct E or A bus from home (no transfers)
                const directBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS'],
                    true // direct route only
                );
                if (directBusOption) {
                    options.push({ 
                        ...directBusOption, 
                        title: 'Option 2: Direct E/A Bus from Home', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Direct bus option failed:', e);
            }

            try {
                // Option 3: Alternative MTR + Bus route
                const altMTROption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS', 'RAIL', 'SUBWAY']
                );
                if (altMTROption && options.length < 4) {
                    options.push({ 
                        ...altMTROption, 
                        title: 'Option 3: MTR + Transit Bus', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('Alternative MTR option failed:', e);
            }

            try {
                // Option 4: Any other bus route
                const altBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS']
                );
                if (altBusOption && options.length < 4) {
                    options.push({ 
                        ...altBusOption, 
                        title: 'Option 4: Alternative Bus Route', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Alternative bus option failed:', e);
            }

            // Return up to 4 options
            return options.slice(0, 4);
        }

        async function getAirportOptions(arrivalTime, destination) {
            // Option 1: MTR to Tung Chung + Transit Bus
            const mtrOption = await getDirections(
                HOME_LOCATION,
                destination,
                arrivalTime,
                'TRANSIT',
                ['BUS', 'RAIL', 'SUBWAY']
            );

            // Option 2: Direct Airport Bus (A or E series preferred)
            const busOption = await getDirections(
                HOME_LOCATION,
                destination,
                arrivalTime,
                'TRANSIT',
                ['BUS']
            );

            return [
                { ...mtrOption, title: 'Option 1: MTR + Bus', badge: 'mtr' },
                { ...busOption, title: 'Option 2: Airport Bus', badge: 'bus' }
            ];
        }

        async function getDirections(origin, destination, arrivalTime, mode, transitModes, directOnly = false) {
            const directionsService = new google.maps.DirectionsService();
            
            const request = {
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(destination.lat, destination.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: transitModes.map(m => google.maps.TransitMode[m]),
                    arrivalTime: arrivalTime
                },
                provideRouteAlternatives: true
            };

            return new Promise((resolve, reject) => {
                directionsService.route(request, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK || !result.routes || result.routes.length === 0) {
                        console.error('Directions API error:', status, result);
                        reject(new Error(`No routes found (${status})`));
                        return;
                    }

                    // If directOnly is true, filter for routes with minimal transfers
                    let route;
                    if (directOnly) {
                        // Find route with fewest transfers (ideally 1 bus)
                        const directRoutes = result.routes.filter(r => {
                            const transitSteps = r.legs[0].steps.filter(s => s.transit);
                            return transitSteps.length === 1;
                        });
                        route = directRoutes[0] || result.routes[0];
                    } else {
                        route = result.routes[0];
                    }

                    const leg = route.legs[0];

                    resolve({
                        duration: leg.duration.text,
                        departureTime: leg.departure_time.text,
                        arrivalTime: leg.arrival_time.text,
                        steps: leg.steps.map(step => ({
                            instruction: step.instructions.replace(/<[^>]*>/g, ''),
                            mode: step.travel_mode,
                            transitDetails: step.transit
                        }))
                    });
                });
            });
        }

        async function getMultiLegRoute(origin, waypoint, destination, arrivalTime, mode1, transitModes1, transitModes2) {
            const directionsService = new google.maps.DirectionsService();
            
            // Get route from waypoint to destination first (we know arrival time)
            const leg2Request = {
                origin: new google.maps.LatLng(waypoint.lat, waypoint.lng),
                destination: new google.maps.LatLng(destination.lat, destination.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: transitModes2.map(m => google.maps.TransitMode[m]),
                    arrivalTime: arrivalTime
                }
            };

            const leg2Result = await new Promise((resolve, reject) => {
                directionsService.route(leg2Request, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`Leg 2 failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const leg2 = leg2Result.routes[0].legs[0];
            
            // Calculate departure time from waypoint (to arrive on time)
            const waypointDepartureTime = new Date(arrivalTime.getTime() - leg2.duration.value * 1000);

            // Get route from origin to waypoint (arriving at waypoint departure time)
            const leg1Request = {
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(waypoint.lat, waypoint.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: transitModes1.map(m => google.maps.TransitMode[m]),
                    arrivalTime: waypointDepartureTime
                }
            };

            const leg1Result = await new Promise((resolve, reject) => {
                directionsService.route(leg1Request, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`Leg 1 failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const leg1 = leg1Result.routes[0].legs[0];

            // Calculate total duration
            const totalDurationSeconds = leg1.duration.value + leg2.duration.value;
            const totalDurationText = Math.floor(totalDurationSeconds / 60) + ' mins';

            // Combine steps
            const allSteps = [
                ...leg1.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                })),
                ...leg2.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                }))
            ];

            return {
                duration: totalDurationText,
                departureTime: leg1.departure_time.text,
                arrivalTime: leg2.arrival_time.text,
                steps: allSteps
            };
        }

        function displayResults(options, dutyTime, advanceMinutes) {
            const resultsDiv = document.getElementById('results');
            
            let html = '<h2 style="margin-bottom: 16px;">Transit Options</h2>';
            html += `<p style="color: var(--color-text-secondary); margin-bottom: 16px;">Report duty at ${dutyTime}, arriving ${advanceMinutes} mins early</p>`;

            options.forEach(option => {
                html += `
                    <div class="option">
                        <div class="option-header">
                            <div class="option-title">${option.title}</div>
                            <div class="option-badge badge-${option.badge}">${option.duration}</div>
                        </div>
                        <div class="option-details">
                            <div class="time-row">
                                <span class="time-label">üè† Leave Home:</span>
                                <span class="time-value">${option.departureTime}</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üè¢ Arrive Company:</span>
                                <span class="time-value">${option.arrivalTime}</span>
                            </div>
                        </div>
                        <div class="steps">
                            ${option.steps.map(step => {
                                let stepText = step.instruction;
                                if (step.transitDetails) {
                                    const transit = step.transitDetails;
                                    stepText = `${transit.line.vehicle.name || 'Transit'}: ${transit.line.short_name || transit.line.name || ''} to ${transit.headsign || ''}`;
                                }
                                return `<div class="step">‚Ä¢ ${stepText}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
