<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bing tools</title>
    <style>
        :root {
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: rgba(50, 184, 198, 1);
                --color-primary-hover: rgba(45, 166, 178, 1);
                --color-primary-active: rgba(41, 150, 161, 1);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-card-border: rgba(119, 124, 124, 0.2);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--color-surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .setup-warning {
            background: rgba(255, 200, 87, 0.15);
            border: 1px solid rgba(255, 200, 87, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .setup-warning h3 {
            color: #d97706;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text);
            font-size: 14px;
        }

        select, input[type="time"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--color-surface);
            color: var(--color-text);
            transition: border-color 0.2s;
        }

        select:focus, input[type="time"]:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .advance-time-group {
            margin-bottom: 20px;
        }

        .advance-time-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .advance-btn {
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .advance-btn:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-teal-500-rgb), 0.1);
        }

        .advance-btn.selected {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-hover);
        }

        .btn:active {
            background: var(--color-primary-active);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results {
            margin-top: 24px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--color-text-secondary);
        }

        .option {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .option-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }

        .option-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-mtr {
            background: rgba(33, 128, 141, 0.15);
            color: var(--color-primary);
        }

        .badge-bus {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .option-details {
            font-size: 14px;
            color: var(--color-text-secondary);
            line-height: 1.8;
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .time-label {
            font-weight: 500;
        }

        .time-value {
            font-weight: 600;
            color: var(--color-text);
        }

        .error {
            background: rgba(192, 21, 47, 0.1);
            border: 1px solid rgba(192, 21, 47, 0.3);
            color: var(--color-red-500);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .steps {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--color-card-border);
        }

        .step {
            padding: 8px 0;
            font-size: 13px;
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíïFor Bing Bingüòò</h1>

        <div class="form-group">
            <label>Select Workplace</label>
            <select id="workplace">
                <option value="cxcity">1Ô∏è‚É£ CX City</option>
                <option value="airport">2Ô∏è‚É£ Airport</option>
            </select>
        </div>

        <div class="form-group">
            <label>Report Duty Time ‚úàÔ∏è</label>
            <input type="time" id="dutyTime" value="11:00">
            <small style="color: var(--color-text-secondary); display: block; margin-top: 4px;">What time do you need to report for duty?</small>
        </div>

        <div class="advance-time-group">
            <label>Advance Time Choose</label>
            <div class="advance-time-buttons">
                <button class="advance-btn" data-minutes="15">15 mins</button>
                <button class="advance-btn" data-minutes="20">20 mins</button>
                <button class="advance-btn" data-minutes="25">25 mins</button>
                <button class="advance-btn selected" data-minutes="30">30 mins</button>
                <button class="advance-btn" data-minutes="35">35 mins</button>
                <button class="advance-btn" data-minutes="40">40 mins</button>
            </div>
            <small style="color: var(--color-text-secondary); display: block; margin-top: 8px;">GOOD LUCK TO YOU!</small>
        </div>

        <button class="btn" onclick="calculateTransit()">Calculate When to Leave</button>

        <div id="results" class="results"></div>

        <!-- Airport Info Section -->
        <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid var(--color-border);">
            <h2 style="font-size: 20px; margin-bottom: 16px;">‚úàÔ∏è Airport Information Lookup Ô∏è‚úàÔ∏è</h2>
            
            <div class="form-group">
                <label>Enter Airport Code (IATA)</label>
                <input type="text" id="airportCode" placeholder=" " style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 14px; background: var(--color-surface); color: var(--color-text); text-transform: uppercase;">
            </div>

            <button class="btn" onclick="lookupAirport()">Search!</button>

            <div id="airportResults" style="margin-top: 16px;"></div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBD5iVr11BID7B1477W8W2tlfi0O0ac1KQ&libraries=places"></script>
    <script>
        // Hardcoded home location (hidden from user)
        const HOME_LOCATION = {lat: 22.316910, lng: 114.163717};

        // Workplace locations
        const WORKPLACES = {
            cxcity: {lat: 22.298189, lng: 113.934747, name: 'CX City'},
            airport: {lat: 22.316076, lng: 113.936037, name: 'Airport'}
        };

        // Your Google Maps API key
        const API_KEY = 'AIzaSyBD5iVr11BID7B1477W8W2tlfi0O0ac1KQ';

        let selectedAdvanceMinutes = 30; // Default

        // Handle advance time button selection
        document.querySelectorAll('.advance-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.advance-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedAdvanceMinutes = parseInt(this.dataset.minutes);
            });
        });

        async function calculateTransit() {
            const workplace = document.getElementById('workplace').value;
            const dutyTime = document.getElementById('dutyTime').value;
            const resultsDiv = document.getElementById('results');

            if (!dutyTime) {
                resultsDiv.innerHTML = '<div class="error">Please enter a duty time.</div>';
                return;
            }

            if (API_KEY === 'YOUR_API_KEY_HERE' || typeof google === 'undefined') {
                resultsDiv.innerHTML = '<div class="error">Please add your Google Maps API key in the code (line 12 and in script src tag).</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">‚è≥ Calculating transit routes...</div>';

            try {
                // Calculate target arrival time (duty time minus advance time)
                const targetArrivalTime = calculateTargetArrivalTime(dutyTime, selectedAdvanceMinutes);
                
                const destination = WORKPLACES[workplace];

                // Get two transit options based on workplace
                let options;
                if (workplace === 'cxcity') {
                    options = await getCXCityOptions(targetArrivalTime, destination);
                } else {
                    options = await getAirportOptions(targetArrivalTime, destination);
                }

                displayResults(options, dutyTime, selectedAdvanceMinutes);
            } catch (error) {
                console.error('Transit calculation error:', error);
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}<br><small>Check browser console for details.</small></div>`;
            }
        }

        function calculateTargetArrivalTime(dutyTime, advanceMinutes) {
            const [hours, minutes] = dutyTime.split(':').map(Number);
            const dutyDate = new Date();
            dutyDate.setHours(hours, minutes, 0, 0);
            
            // Subtract advance time
            const targetDate = new Date(dutyDate.getTime() - advanceMinutes * 60000);
            
            return targetDate;
        }

        async function getCXCityOptions(arrivalTime, destination) {
            const tungChungBusTerminus = {lat: 22.289547245983123, lng: 113.94052342186916};
            const options = [];

            try {
                // Option 1: MTR to Tung Chung + S/E bus from Tung Chung Station Bus Terminus
                const mtrToBusOption = await getMultiLegRoute(
                    HOME_LOCATION,
                    tungChungBusTerminus,
                    null,
                    destination,
                    arrivalTime,
                    ['RAIL', 'SUBWAY'],
                    ['BUS']
                );
                if (mtrToBusOption) {
                    options.push({ 
                        ...mtrToBusOption, 
                        title: 'Option 1: MTR ‚Üí Tung Chung ‚Üí S/E Bus', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('MTR + Bus option failed:', e);
            }

            try {
                // Option 2: Direct E or A bus from home (no transfers)
                const directBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS'],
                    true // direct route only
                );
                if (directBusOption) {
                    options.push({ 
                        ...directBusOption, 
                        title: 'Option 2: Direct E/A Bus from Home', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Direct bus option failed:', e);
            }

            try {
                // Option 3: Alternative MTR + Bus route
                const altMTROption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS', 'RAIL', 'SUBWAY']
                );
                if (altMTROption && options.length < 4) {
                    options.push({ 
                        ...altMTROption, 
                        title: 'Option 3: MTR + Transit Bus', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('Alternative MTR option failed:', e);
            }

            try {
                // Option 4: Any other bus route
                const altBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS']
                );
                if (altBusOption && options.length < 4) {
                    options.push({ 
                        ...altBusOption, 
                        title: 'Option 4: Alternative Bus Route', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Alternative bus option failed:', e);
            }

            // Return up to 4 options
            return options.slice(0, 4);
        }

        async function getAirportOptions(arrivalTime, destination) {
            const olympicStation = {lat: 22.318100, lng: 114.159800};
            const tsingYiStation = {lat: 22.357400, lng: 114.108600};
            const options = [];

            try {
                // Option 1: Home ‚Üí Olympic (Walk/MTR) ‚Üí Tsing Yi (MTR) ‚Üí Airport (AEL)
                // Break into segments since Google doesn't recognize full 3-leg transit well
                const aelOption = await getAirportExpressRoute(
                    HOME_LOCATION,
                    olympicStation,
                    tsingYiStation,
                    destination,
                    arrivalTime
                );
                if (aelOption) {
                    options.push({ 
                        ...aelOption, 
                        title: 'Option 1: MTR ‚Üí Olympic ‚Üí AEL from Tsing Yi', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('AEL option failed:', e);
            }

            try {
                // Option 2: Direct E or A bus from home (no transfers)
                const directBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS'],
                    true // direct route only
                );
                if (directBusOption) {
                    options.push({ 
                        ...directBusOption, 
                        title: 'Option 2: Direct E/A Bus from Home', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Direct bus option failed:', e);
            }

            try {
                // Option 3: Alternative MTR + Bus route
                const altMTROption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS', 'RAIL', 'SUBWAY']
                );
                if (altMTROption && options.length < 4) {
                    options.push({ 
                        ...altMTROption, 
                        title: 'Option 3: MTR + Transit Bus', 
                        badge: 'mtr' 
                    });
                }
            } catch (e) {
                console.error('Alternative MTR option failed:', e);
            }

            try {
                // Option 4: Any other bus route
                const altBusOption = await getDirections(
                    HOME_LOCATION,
                    destination,
                    arrivalTime,
                    'TRANSIT',
                    ['BUS']
                );
                if (altBusOption && options.length < 4) {
                    options.push({ 
                        ...altBusOption, 
                        title: 'Option 4: Alternative Bus Route', 
                        badge: 'bus' 
                    });
                }
            } catch (e) {
                console.error('Alternative bus option failed:', e);
            }

            // Return up to 4 options
            return options.slice(0, 4);
        }

        async function getAirportExpressRoute(origin, olympicStation, tsingYiStation, destination, arrivalTime) {
            const directionsService = new google.maps.DirectionsService();
            
            // Simplified approach: Home ‚Üí Tsing Yi ‚Üí Airport
            // This better matches actual travel patterns (MTR to Tsing Yi, then AEL)
            
            // Step 1: Get Airport Express timing from Tsing Yi to Airport
            const aelRequest = {
                origin: new google.maps.LatLng(tsingYiStation.lat, tsingYiStation.lng),
                destination: new google.maps.LatLng(destination.lat, destination.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: [google.maps.TransitMode.RAIL],
                    arrivalTime: arrivalTime
                }
            };

            const aelResult = await new Promise((resolve, reject) => {
                directionsService.route(aelRequest, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`Airport Express route failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const aelLeg = aelResult.routes[0].legs[0];
            const tsingYiDepartureTime = new Date(arrivalTime.getTime() - aelLeg.duration.value * 1000);

            // Step 2: Get MTR from home area to Tsing Yi (via Olympic if needed)
            const mtrRequest = {
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(tsingYiStation.lat, tsingYiStation.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: [google.maps.TransitMode.SUBWAY, google.maps.TransitMode.RAIL],
                    arrivalTime: tsingYiDepartureTime
                }
            };

            const mtrResult = await new Promise((resolve, reject) => {
                directionsService.route(mtrRequest, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`MTR to Tsing Yi route failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const mtrLeg = mtrResult.routes[0].legs[0];

            // Calculate total duration
            const totalDurationSeconds = mtrLeg.duration.value + aelLeg.duration.value;
            const totalDurationText = Math.floor(totalDurationSeconds / 60) + ' mins';

            // Combine steps
            const allSteps = [
                ...mtrLeg.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                })),
                ...aelLeg.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                }))
            ];

            return {
                duration: totalDurationText,
                departureTime: mtrLeg.departure_time.text,
                arrivalTime: aelLeg.arrival_time.text,
                steps: allSteps
            };
        }

        async function getDirections(origin, destination, arrivalTime, mode, transitModes, directOnly = false) {
            const directionsService = new google.maps.DirectionsService();
            
            const request = {
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(destination.lat, destination.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: transitModes.map(m => google.maps.TransitMode[m]),
                    arrivalTime: arrivalTime
                },
                provideRouteAlternatives: true
            };

            return new Promise((resolve, reject) => {
                directionsService.route(request, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK || !result.routes || result.routes.length === 0) {
                        console.error('Directions API error:', status, result);
                        reject(new Error(`No routes found (${status})`));
                        return;
                    }

                    // If directOnly is true, filter for routes with minimal transfers
                    let route;
                    if (directOnly) {
                        // Find route with fewest transfers (ideally 1 bus)
                        const directRoutes = result.routes.filter(r => {
                            const transitSteps = r.legs[0].steps.filter(s => s.transit);
                            return transitSteps.length === 1;
                        });
                        route = directRoutes[0] || result.routes[0];
                    } else {
                        route = result.routes[0];
                    }

                    const leg = route.legs[0];

                    resolve({
                        duration: leg.duration.text,
                        departureTime: leg.departure_time.text,
                        arrivalTime: leg.arrival_time.text,
                        steps: leg.steps.map(step => ({
                            instruction: step.instructions.replace(/<[^>]*>/g, ''),
                            mode: step.travel_mode,
                            transitDetails: step.transit
                        }))
                    });
                });
            });
        }

        async function getMultiLegRoute(origin, waypoint1, waypoint2, destination, arrivalTime, transitModes1, transitModes2) {
            const directionsService = new google.maps.DirectionsService();
            
            // If waypoint2 exists, this is a 3-leg journey (Home ‚Üí Waypoint1 ‚Üí Waypoint2 ‚Üí Destination)
            // Otherwise, it's a 2-leg journey (Home ‚Üí Waypoint ‚Üí Destination)
            const isThreeLeg = waypoint2 !== undefined && waypoint2 !== null;
            
            if (isThreeLeg) {
                // Three-leg route: Home ‚Üí Olympic ‚Üí Tsing Yi ‚Üí Airport
                
                // Leg 3: Tsing Yi to Airport (we know arrival time)
                const leg3Request = {
                    origin: new google.maps.LatLng(waypoint2.lat, waypoint2.lng),
                    destination: new google.maps.LatLng(destination.lat, destination.lng),
                    travelMode: google.maps.TravelMode.TRANSIT,
                    transitOptions: {
                        modes: transitModes2.map(m => google.maps.TransitMode[m]),
                        arrivalTime: arrivalTime
                    }
                };

                const leg3Result = await new Promise((resolve, reject) => {
                    directionsService.route(leg3Request, (result, status) => {
                        if (status !== google.maps.DirectionsStatus.OK) {
                            reject(new Error(`Leg 3 failed: ${status}`));
                            return;
                        }
                        resolve(result);
                    });
                });

                const leg3 = leg3Result.routes[0].legs[0];
                const waypoint2DepartureTime = new Date(arrivalTime.getTime() - leg3.duration.value * 1000);

                // Leg 2: Olympic to Tsing Yi
                const leg2Request = {
                    origin: new google.maps.LatLng(waypoint1.lat, waypoint1.lng),
                    destination: new google.maps.LatLng(waypoint2.lat, waypoint2.lng),
                    travelMode: google.maps.TravelMode.TRANSIT,
                    transitOptions: {
                        modes: transitModes1.map(m => google.maps.TransitMode[m]),
                        arrivalTime: waypoint2DepartureTime
                    }
                };

                const leg2Result = await new Promise((resolve, reject) => {
                    directionsService.route(leg2Request, (result, status) => {
                        if (status !== google.maps.DirectionsStatus.OK) {
                            reject(new Error(`Leg 2 failed: ${status}`));
                            return;
                        }
                        resolve(result);
                    });
                });

                const leg2 = leg2Result.routes[0].legs[0];
                const waypoint1DepartureTime = new Date(waypoint2DepartureTime.getTime() - leg2.duration.value * 1000);

                // Leg 1: Home to Olympic
                const leg1Request = {
                    origin: new google.maps.LatLng(origin.lat, origin.lng),
                    destination: new google.maps.LatLng(waypoint1.lat, waypoint1.lng),
                    travelMode: google.maps.TravelMode.TRANSIT,
                    transitOptions: {
                        modes: transitModes1.map(m => google.maps.TransitMode[m]),
                        arrivalTime: waypoint1DepartureTime
                    }
                };

                const leg1Result = await new Promise((resolve, reject) => {
                    directionsService.route(leg1Request, (result, status) => {
                        if (status !== google.maps.DirectionsStatus.OK) {
                            reject(new Error(`Leg 1 failed: ${status}`));
                            return;
                        }
                        resolve(result);
                    });
                });

                const leg1 = leg1Result.routes[0].legs[0];

                // Calculate total duration
                const totalDurationSeconds = leg1.duration.value + leg2.duration.value + leg3.duration.value;
                const totalDurationText = Math.floor(totalDurationSeconds / 60) + ' mins';

                // Combine steps
                const allSteps = [
                    ...leg1.steps.map(step => ({
                        instruction: step.instructions.replace(/<[^>]*>/g, ''),
                        mode: step.travel_mode,
                        transitDetails: step.transit
                    })),
                    ...leg2.steps.map(step => ({
                        instruction: step.instructions.replace(/<[^>]*>/g, ''),
                        mode: step.travel_mode,
                        transitDetails: step.transit
                    })),
                    ...leg3.steps.map(step => ({
                        instruction: step.instructions.replace(/<[^>]*>/g, ''),
                        mode: step.travel_mode,
                        transitDetails: step.transit
                    }))
                ];

                return {
                    duration: totalDurationText,
                    departureTime: leg1.departure_time.text,
                    arrivalTime: leg3.arrival_time.text,
                    steps: allSteps
                };
            }
            
            // Two-leg route (original logic for CX City)
            const finalDestination = destination || waypoint2;
            
            // Get route from waypoint to destination first (we know arrival time)
            const leg2Request = {
                origin: new google.maps.LatLng(waypoint1.lat, waypoint1.lng),
                destination: new google.maps.LatLng(finalDestination.lat, finalDestination.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: transitModes2.map(m => google.maps.TransitMode[m]),
                    arrivalTime: arrivalTime
                }
            };

            const leg2Result = await new Promise((resolve, reject) => {
                directionsService.route(leg2Request, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`Leg 2 failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const leg2 = leg2Result.routes[0].legs[0];
            
            // Calculate departure time from waypoint (to arrive on time)
            const waypointDepartureTime = new Date(arrivalTime.getTime() - leg2.duration.value * 1000);

            // Get route from origin to waypoint (arriving at waypoint departure time)
            const leg1Request = {
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(waypoint1.lat, waypoint1.lng),
                travelMode: google.maps.TravelMode.TRANSIT,
                transitOptions: {
                    modes: transitModes1.map(m => google.maps.TransitMode[m]),
                    arrivalTime: waypointDepartureTime
                }
            };

            const leg1Result = await new Promise((resolve, reject) => {
                directionsService.route(leg1Request, (result, status) => {
                    if (status !== google.maps.DirectionsStatus.OK) {
                        reject(new Error(`Leg 1 failed: ${status}`));
                        return;
                    }
                    resolve(result);
                });
            });

            const leg1 = leg1Result.routes[0].legs[0];

            // Calculate total duration
            const totalDurationSeconds = leg1.duration.value + leg2.duration.value;
            const totalDurationText = Math.floor(totalDurationSeconds / 60) + ' mins';

            // Combine steps
            const allSteps = [
                ...leg1.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                })),
                ...leg2.steps.map(step => ({
                    instruction: step.instructions.replace(/<[^>]*>/g, ''),
                    mode: step.travel_mode,
                    transitDetails: step.transit
                }))
            ];

            return {
                duration: totalDurationText,
                departureTime: leg1.departure_time.text,
                arrivalTime: leg2.arrival_time.text,
                steps: allSteps
            };
        }

        function displayResults(options, dutyTime, advanceMinutes) {
            const resultsDiv = document.getElementById('results');
            
            let html = '<h2 style="margin-bottom: 16px;">Transit Options</h2>';
            html += `<p style="color: var(--color-text-secondary); margin-bottom: 16px;">Report duty at ${dutyTime}, arriving ${advanceMinutes} mins early</p>`;

            options.forEach(option => {
                html += `
                    <div class="option">
                        <div class="option-header">
                            <div class="option-title">${option.title}</div>
                            <div class="option-badge badge-${option.badge}">${option.duration}</div>
                        </div>
                        <div class="option-details">
                            <div class="time-row">
                                <span class="time-label">üè† Leave Home:</span>
                                <span class="time-value">${option.departureTime}</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üè¢ Arrive Company:</span>
                                <span class="time-value">${option.arrivalTime}</span>
                            </div>
                        </div>
                        <div class="steps">
                            ${option.steps.map(step => {
                                let stepText = step.instruction;
                                if (step.transitDetails) {
                                    const transit = step.transitDetails;
                                    stepText = `${transit.line.vehicle.name || 'Transit'}: ${transit.line.short_name || transit.line.name || ''} to ${transit.headsign || ''}`;
                                }
                                return `<div class="step">‚Ä¢ ${stepText}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Embedded airport database (160+ major airports worldwide)
        const AIRPORTS_DB = {
            // Original 20 airports
            "JFK": {name: "John F Kennedy International Airport", city: "New York", country: "US", lat: 40.6413, lng: -73.7781, tz: "America/New_York"},
            "LAX": {name: "Los Angeles International Airport", city: "Los Angeles", country: "US", lat: 33.9416, lng: -118.4085, tz: "America/Los_Angeles"},
            "LHR": {name: "London Heathrow Airport", city: "London", country: "GB", lat: 51.4700, lng: -0.4543, tz: "Europe/London"},
            "HKG": {name: "Hong Kong International Airport", city: "Hong Kong", country: "HK", lat: 22.3080, lng: 113.9185, tz: "Asia/Hong_Kong"},
            "NRT": {name: "Narita International Airport", city: "Tokyo", country: "JP", lat: 35.7647, lng: 140.3864, tz: "Asia/Tokyo"},
            "CDG": {name: "Charles de Gaulle Airport", city: "Paris", country: "FR", lat: 49.0097, lng: 2.5479, tz: "Europe/Paris"},
            "DXB": {name: "Dubai International Airport", city: "Dubai", country: "AE", lat: 25.2532, lng: 55.3657, tz: "Asia/Dubai"},
            "SIN": {name: "Singapore Changi Airport", city: "Singapore", country: "SG", lat: 1.3644, lng: 103.9915, tz: "Asia/Singapore"},
            "ICN": {name: "Incheon International Airport", city: "Seoul", country: "KR", lat: 37.4602, lng: 126.4407, tz: "Asia/Seoul"},
            "SYD": {name: "Sydney Kingsford Smith Airport", city: "Sydney", country: "AU", lat: -33.9461, lng: 151.1772, tz: "Australia/Sydney"},
            "TPE": {name: "Taiwan Taoyuan International Airport", city: "Taipei", country: "TW", lat: 25.0797, lng: 121.2342, tz: "Asia/Taipei"},
            "BKK": {name: "Suvarnabhumi Airport", city: "Bangkok", country: "TH", lat: 13.6900, lng: 100.7501, tz: "Asia/Bangkok"},
            "FRA": {name: "Frankfurt Airport", city: "Frankfurt", country: "DE", lat: 50.0379, lng: 8.5622, tz: "Europe/Berlin"},
            "AMS": {name: "Amsterdam Airport Schiphol", city: "Amsterdam", country: "NL", lat: 52.3105, lng: 4.7683, tz: "Europe/Amsterdam"},
            "ORD": {name: "O'Hare International Airport", city: "Chicago", country: "US", lat: 41.9742, lng: -87.9073, tz: "America/Chicago"},
            "SFO": {name: "San Francisco International Airport", city: "San Francisco", country: "US", lat: 37.6213, lng: -122.3790, tz: "America/Los_Angeles"},
            "MIA": {name: "Miami International Airport", city: "Miami", country: "US", lat: 25.7959, lng: -80.2870, tz: "America/New_York"},
            "YYZ": {name: "Toronto Pearson International Airport", city: "Toronto", country: "CA", lat: 43.6777, lng: -79.6248, tz: "America/Toronto"},
            "MEX": {name: "Mexico City International Airport", city: "Mexico City", country: "MX", lat: 19.4363, lng: -99.0721, tz: "America/Mexico_City"},
            "GRU": {name: "S√£o Paulo/Guarulhos International Airport", city: "S√£o Paulo", country: "BR", lat: -23.4356, lng: -46.4731, tz: "America/Sao_Paulo"},
            
            // Australia
            "ADL": {name: "Adelaide Airport", city: "Adelaide", country: "AU", lat: -34.945, lng: 138.531, tz: "Australia/Adelaide"},
            "CNS": {name: "Cairns Airport", city: "Cairns", country: "AU", lat: -16.886, lng: 145.755, tz: "Australia/Brisbane"},
            "HBA": {name: "Hobart Airport", city: "Hobart", country: "AU", lat: -42.836, lng: 147.510, tz: "Australia/Hobart"},
            "PER": {name: "Perth Airport", city: "Perth", country: "AU", lat: -31.940, lng: 115.967, tz: "Australia/Perth"},
            "WTB": {name: "Toowoomba Wellcamp Airport", city: "Toowoomba", country: "AU", lat: -27.558, lng: 151.916, tz: "Australia/Brisbane"},
            
            // Asia
            "DAC": {name: "Hazrat Shahjalal International Airport", city: "Dhaka", country: "BD", lat: 23.843, lng: 90.398, tz: "Asia/Dhaka"},
            "PNH": {name: "Techo International Airport", city: "Phnom Penh", country: "KH", lat: 11.547, lng: 104.845, tz: "Asia/Phnom_Penh"},
            "CTU": {name: "Chengdu Tianfu International Airport", city: "Chengdu", country: "CN", lat: 30.308, lng: 104.443, tz: "Asia/Shanghai"},
            "CKG": {name: "Chongqing Jiangbei International Airport", city: "Chongqing", country: "CN", lat: 29.719, lng: 106.642, tz: "Asia/Shanghai"},
            "FOC": {name: "Fuzhou Changle International Airport", city: "Fuzhou", country: "CN", lat: 25.935, lng: 119.663, tz: "Asia/Shanghai"},
            "HAK": {name: "Haikou Meilan International Airport", city: "Haikou", country: "CN", lat: 19.935, lng: 110.459, tz: "Asia/Shanghai"},
            "HGH": {name: "Hangzhou Xiaoshan International Airport", city: "Hangzhou", country: "CN", lat: 30.229, lng: 120.434, tz: "Asia/Shanghai"},
            "NKG": {name: "Nanjing Lukou International Airport", city: "Nanjing", country: "CN", lat: 31.742, lng: 118.862, tz: "Asia/Shanghai"},
            "NGB": {name: "Ningbo Lishe International Airport", city: "Ningbo", country: "CN", lat: 29.827, lng: 121.462, tz: "Asia/Shanghai"},
            "TAO": {name: "Qingdao Jiaodong International Airport", city: "Qingdao", country: "CN", lat: 36.267, lng: 120.374, tz: "Asia/Shanghai"},
            "SYX": {name: "Sanya Phoenix International Airport", city: "Sanya", country: "CN", lat: 18.303, lng: 109.412, tz: "Asia/Shanghai"},
            "SHA": {name: "Shanghai Hongqiao International Airport", city: "Shanghai", country: "CN", lat: 31.198, lng: 121.336, tz: "Asia/Shanghai"},
            "URC": {name: "√úr√ºmqi Tianshan International Airport", city: "√úr√ºmqi", country: "CN", lat: 43.907, lng: 87.474, tz: "Asia/Urumqi"},
            "WNZ": {name: "Wenzhou Yongqiang International Airport", city: "Wenzhou", country: "CN", lat: 27.912, lng: 120.852, tz: "Asia/Shanghai"},
            "WUH": {name: "Wuhan Tianhe International Airport", city: "Wuhan", country: "CN", lat: 30.784, lng: 114.208, tz: "Asia/Shanghai"},
            "XMN": {name: "Xiamen Gaoqi International Airport", city: "Xiamen", country: "CN", lat: 24.544, lng: 118.128, tz: "Asia/Shanghai"},
            "CGO": {name: "Zhengzhou Xinzheng International Airport", city: "Zhengzhou", country: "CN", lat: 34.520, lng: 113.841, tz: "Asia/Shanghai"},
            "BLR": {name: "Kempegowda International Airport", city: "Bengaluru", country: "IN", lat: 13.199, lng: 77.706, tz: "Asia/Kolkata"},
            "MAA": {name: "Chennai International Airport", city: "Chennai", country: "IN", lat: 12.990, lng: 80.169, tz: "Asia/Kolkata"},
            "DPS": {name: "Ngurah Rai International Airport", city: "Denpasar (Bali)", country: "ID", lat: -8.748, lng: 115.167, tz: "Asia/Makassar"},
            "SUB": {name: "Juanda International Airport", city: "Surabaya", country: "ID", lat: -7.380, lng: 112.787, tz: "Asia/Jakarta"},
            "FUK": {name: "Fukuoka Airport", city: "Fukuoka", country: "JP", lat: 33.586, lng: 130.451, tz: "Asia/Tokyo"},
            "NGO": {name: "Chubu Centrair International Airport", city: "Nagoya", country: "JP", lat: 34.858, lng: 136.805, tz: "Asia/Tokyo"},
            "CTS": {name: "New Chitose Airport", city: "Sapporo", country: "JP", lat: 42.775, lng: 141.692, tz: "Asia/Tokyo"},
            "PEN": {name: "Penang International Airport", city: "Penang", country: "MY", lat: 5.297, lng: 100.277, tz: "Asia/Kuala_Lumpur"},
            "KTM": {name: "Tribhuvan International Airport", city: "Kathmandu", country: "NP", lat: 27.697, lng: 85.359, tz: "Asia/Kathmandu"},
            "CEB": {name: "Mactan‚ÄìCebu International Airport", city: "Cebu", country: "PH", lat: 10.308, lng: 123.979, tz: "Asia/Manila"},
            "RUH": {name: "King Khalid International Airport", city: "Riyadh", country: "SA", lat: 24.958, lng: 46.699, tz: "Asia/Riyadh"},
            "CMB": {name: "Bandaranaike International Airport", city: "Colombo", country: "LK", lat: 7.181, lng: 79.884, tz: "Asia/Colombo"},
            
            // Europe
            "BRU": {name: "Brussels Airport", city: "Brussels", country: "BE", lat: 50.901, lng: 4.484, tz: "Europe/Brussels"},
            "MXP": {name: "Milan Malpensa Airport", city: "Milan", country: "IT", lat: 45.630, lng: 8.728, tz: "Europe/Rome"},
            "FCO": {name: "Rome Fiumicino Airport", city: "Rome", country: "IT", lat: 41.804, lng: 12.251, tz: "Europe/Rome"},
            "BCN": {name: "Josep Tarradellas Barcelona‚ÄìEl Prat Airport", city: "Barcelona", country: "ES", lat: 41.297, lng: 2.078, tz: "Europe/Madrid"},
            "MAD": {name: "Adolfo Su√°rez Madrid‚ÄìBarajas Airport", city: "Madrid", country: "ES", lat: 40.472, lng: -3.561, tz: "Europe/Madrid"},
            "MAN": {name: "Manchester Airport", city: "Manchester", country: "GB", lat: 53.354, lng: -2.275, tz: "Europe/London"},
            
            // Africa
            "JNB": {name: "O. R. Tambo International Airport", city: "Johannesburg", country: "ZA", lat: -26.139, lng: 28.246, tz: "Africa/Johannesburg"},
            
            // North America
            "YYC": {name: "Calgary International Airport", city: "Calgary", country: "CA", lat: 51.114, lng: -114.020, tz: "America/Edmonton"},
            "BOS": {name: "Logan International Airport", city: "Boston", country: "US", lat: 42.364, lng: -71.005, tz: "America/New_York"},
            "DFW": {name: "Dallas Fort Worth International Airport", city: "Dallas", country: "US", lat: 32.897, lng: -97.038, tz: "America/Chicago"},
            "SEA": {name: "Seattle‚ÄìTacoma International Airport", city: "Seattle", country: "US", lat: 47.449, lng: -122.309, tz: "America/Los_Angeles"},
            "PDX": {name: "Portland International Airport", city: "Portland", country: "US", lat: 45.589, lng: -122.598, tz: "America/Los_Angeles"},
            "IAH": {name: "George Bush Intercontinental Airport", city: "Houston", country: "US", lat: 29.984, lng: -95.342, tz: "America/Chicago"},
            "ATL": {name: "Hartsfield‚ÄìJackson Atlanta International Airport", city: "Atlanta", country: "US", lat: 33.636, lng: -84.428, tz: "America/New_York"},
            "GDL": {name: "Guadalajara International Airport", city: "Guadalajara", country: "MX", lat: 20.522, lng: -103.311, tz: "America/Mexico_City"},
            
            // Additional major airports from comprehensive IATA codes list
            "AAL": {name: "Aalborg Airport", city: "Aalborg", country: "DK", lat: 57.093, lng: 9.849, tz: "Europe/Copenhagen"},
            "AAR": {name: "Aarhus Airport", city: "Aarhus", country: "DK", lat: 56.300, lng: 10.619, tz: "Europe/Copenhagen"},
            "ACA": {name: "General Juan N Alvarez International Airport", city: "Acapulco", country: "MX", lat: 16.757, lng: -99.754, tz: "America/Mexico_City"},
            "ACC": {name: "Kotoka International Airport", city: "Accra", country: "GH", lat: 5.605, lng: -0.167, tz: "Africa/Accra"},
            "ADD": {name: "Addis Ababa Bole International Airport", city: "Addis Ababa", country: "ET", lat: 8.978, lng: 38.799, tz: "Africa/Addis_Ababa"},
            "ADE": {name: "Aden International Airport", city: "Aden", country: "YE", lat: 12.829, lng: 45.029, tz: "Asia/Aden"},
            "AGA": {name: "Agadir-Al Massira Airport", city: "Agadir", country: "MA", lat: 30.325, lng: -9.413, tz: "Africa/Casablanca"},
            "AGU": {name: "Aguascalientes International Airport", city: "Aguascalientes", country: "MX", lat: 21.705, lng: -102.318, tz: "America/Mexico_City"},
            "AKL": {name: "Auckland Airport", city: "Auckland", country: "NZ", lat: -37.008, lng: 174.792, tz: "Pacific/Auckland"},
            "ALC": {name: "Alicante-Elche Airport", city: "Alicante", country: "ES", lat: 38.282, lng: -0.558, tz: "Europe/Madrid"},
            "ALG": {name: "Houari Boumediene Airport", city: "Algiers", country: "DZ", lat: 36.691, lng: 3.215, tz: "Africa/Algiers"},
            "AMM": {name: "Queen Alia International Airport", city: "Amman", country: "JO", lat: 31.722, lng: 35.993, tz: "Asia/Amman"},
            "ANC": {name: "Ted Stevens Anchorage International Airport", city: "Anchorage", country: "US", lat: 61.174, lng: -149.996, tz: "America/Anchorage"},
            "AUA": {name: "Queen Beatrix International Airport", city: "Aruba", country: "AW", lat: 12.501, lng: -70.015, tz: "America/Aruba"},
            "AUH": {name: "Abu Dhabi International Airport", city: "Abu Dhabi", country: "AE", lat: 24.433, lng: 54.651, tz: "Asia/Dubai"},
            "AYT": {name: "Antalya Airport", city: "Antalya", country: "TR", lat: 36.899, lng: 30.800, tz: "Europe/Istanbul"},
            "BAH": {name: "Bahrain International Airport", city: "Bahrain", country: "BH", lat: 26.271, lng: 50.634, tz: "Asia/Bahrain"},
            "BEG": {name: "Belgrade Nikola Tesla Airport", city: "Belgrade", country: "RS", lat: 44.818, lng: 20.309, tz: "Europe/Belgrade"},
            "BEY": {name: "Rafic Hariri International Airport", city: "Beirut", country: "LB", lat: 33.821, lng: 35.488, tz: "Asia/Beirut"},
            "BGO": {name: "Bergen Airport Flesland", city: "Bergen", country: "NO", lat: 60.293, lng: 5.218, tz: "Europe/Oslo"},
            "BGW": {name: "Baghdad International Airport", city: "Baghdad", country: "IQ", lat: 33.262, lng: 44.235, tz: "Asia/Baghdad"},
            "BNE": {name: "Brisbane Airport", city: "Brisbane", country: "AU", lat: -27.384, lng: 153.118, tz: "Australia/Brisbane"},
            "BOG": {name: "El Dorado International Airport", city: "Bogota", country: "CO", lat: 4.702, lng: -74.147, tz: "America/Bogota"},
            "BOM": {name: "Chhatrapati Shivaji International Airport", city: "Mumbai", country: "IN", lat: 19.089, lng: 72.868, tz: "Asia/Kolkata"},
            "BUD": {name: "Budapest Ferenc Liszt International Airport", city: "Budapest", country: "HU", lat: 47.430, lng: 19.261, tz: "Europe/Budapest"},
            "BWI": {name: "Baltimore/Washington International Airport", city: "Baltimore", country: "US", lat: 39.175, lng: -76.668, tz: "America/New_York"},
            "CAI": {name: "Cairo International Airport", city: "Cairo", country: "EG", lat: 30.122, lng: 31.406, tz: "Africa/Cairo"},
            "CAN": {name: "Guangzhou Baiyun International Airport", city: "Guangzhou", country: "CN", lat: 23.392, lng: 113.299, tz: "Asia/Shanghai"},
            "CCU": {name: "Netaji Subhash Chandra Bose International Airport", city: "Kolkata", country: "IN", lat: 22.655, lng: 88.447, tz: "Asia/Kolkata"},
            "CGK": {name: "Soekarno-Hatta International Airport", city: "Jakarta", country: "ID", lat: -6.126, lng: 106.656, tz: "Asia/Jakarta"},
            "CHC": {name: "Christchurch International Airport", city: "Christchurch", country: "NZ", lat: -43.489, lng: 172.532, tz: "Pacific/Auckland"},
            "CJU": {name: "Jeju International Airport", city: "Jeju", country: "KR", lat: 33.511, lng: 126.493, tz: "Asia/Seoul"},
            "CLO": {name: "Alfonso Bonilla Aragon International Airport", city: "Cali", country: "CO", lat: 3.543, lng: -76.381, tz: "America/Bogota"},
            "CMN": {name: "Mohammed V International Airport", city: "Casablanca", country: "MA", lat: 33.368, lng: -7.590, tz: "Africa/Casablanca"},
            "CPH": {name: "Copenhagen Airport", city: "Copenhagen", country: "DK", lat: 55.618, lng: 12.656, tz: "Europe/Copenhagen"},
            "CPT": {name: "Cape Town International Airport", city: "Cape Town", country: "ZA", lat: -33.965, lng: 18.602, tz: "Africa/Johannesburg"},
            "CUN": {name: "Cancun International Airport", city: "Cancun", country: "MX", lat: 21.037, lng: -86.877, tz: "America/Cancun"},
            "DAM": {name: "Damascus International Airport", city: "Damascus", country: "SY", lat: 33.411, lng: 36.516, tz: "Asia/Damascus"},
            "DEL": {name: "Indira Gandhi International Airport", city: "Delhi", country: "IN", lat: 28.566, lng: 77.103, tz: "Asia/Kolkata"},
            "DEN": {name: "Denver International Airport", city: "Denver", country: "US", lat: 39.862, lng: -104.673, tz: "America/Denver"},
            "DOH": {name: "Hamad International Airport", city: "Doha", country: "QA", lat: 25.261, lng: 51.565, tz: "Asia/Qatar"},
            "DTW": {name: "Detroit Metropolitan Wayne County Airport", city: "Detroit", country: "US", lat: 42.212, lng: -83.353, tz: "America/Detroit"},
            "DUB": {name: "Dublin Airport", city: "Dublin", country: "IE", lat: 53.421, lng: -6.270, tz: "Europe/Dublin"},
            "DUR": {name: "King Shaka International Airport", city: "Durban", country: "ZA", lat: -29.615, lng: 31.120, tz: "Africa/Johannesburg"},
            "DUS": {name: "Dusseldorf Airport", city: "Dusseldorf", country: "DE", lat: 51.290, lng: 6.767, tz: "Europe/Berlin"},
            "EDI": {name: "Edinburgh Airport", city: "Edinburgh", country: "GB", lat: 55.950, lng: -3.372, tz: "Europe/London"},
            "EWR": {name: "Newark Liberty International Airport", city: "Newark", country: "US", lat: 40.692, lng: -74.169, tz: "America/New_York"},
            "EZE": {name: "Ministro Pistarini International Airport", city: "Buenos Aires", country: "AR", lat: -34.822, lng: -58.536, tz: "America/Argentina/Buenos_Aires"},
            "GIG": {name: "Rio de Janeiro-Gale√£o International Airport", city: "Rio de Janeiro", country: "BR", lat: -22.810, lng: -43.251, tz: "America/Sao_Paulo"},
            "GLA": {name: "Glasgow Airport", city: "Glasgow", country: "GB", lat: 55.872, lng: -4.433, tz: "Europe/London"},
            "GND": {name: "Maurice Bishop International Airport", city: "Grenada", country: "GD", lat: 12.004, lng: -61.786, tz: "America/Grenada"},
            "GUA": {name: "La Aurora International Airport", city: "Guatemala City", country: "GT", lat: 14.583, lng: -90.527, tz: "America/Guatemala"},
            "GUM": {name: "Antonio B. Won Pat International Airport", city: "Guam", country: "GU", lat: 13.484, lng: 144.796, tz: "Pacific/Guam"},
            "GYE": {name: "Jos√© Joaqu√≠n de Olmedo International Airport", city: "Guayaquil", country: "EC", lat: -2.158, lng: -79.884, tz: "America/Guayaquil"},
            "HAJ": {name: "Hannover Airport", city: "Hannover", country: "DE", lat: 52.461, lng: 9.685, tz: "Europe/Berlin"},
            "HAM": {name: "Hamburg Airport", city: "Hamburg", country: "DE", lat: 53.630, lng: 9.988, tz: "Europe/Berlin"},
            "HAN": {name: "Noi Bai International Airport", city: "Hanoi", country: "VN", lat: 21.221, lng: 105.807, tz: "Asia/Ho_Chi_Minh"},
            "HEL": {name: "Helsinki-Vantaa Airport", city: "Helsinki", country: "FI", lat: 60.317, lng: 24.963, tz: "Europe/Helsinki"},
            "HND": {name: "Tokyo Haneda Airport", city: "Tokyo", country: "JP", lat: 35.553, lng: 139.781, tz: "Asia/Tokyo"},
            "HNL": {name: "Daniel K. Inouye International Airport", city: "Honolulu", country: "US", lat: 21.319, lng: -157.924, tz: "Pacific/Honolulu"},
            "HRE": {name: "Robert Gabriel Mugabe International Airport", city: "Harare", country: "ZW", lat: -17.932, lng: 31.093, tz: "Africa/Harare"},
            "IAD": {name: "Washington Dulles International Airport", city: "Washington DC", country: "US", lat: 38.953, lng: -77.457, tz: "America/New_York"},
            "IND": {name: "Indianapolis International Airport", city: "Indianapolis", country: "US", lat: 39.717, lng: -86.294, tz: "America/Indiana/Indianapolis"},
            "IST": {name: "Istanbul Airport", city: "Istanbul", country: "TR", lat: 41.275, lng: 28.752, tz: "Europe/Istanbul"},
            "JAX": {name: "Jacksonville International Airport", city: "Jacksonville", country: "US", lat: 30.494, lng: -81.688, tz: "America/New_York"},
            "JED": {name: "King Abdulaziz International Airport", city: "Jeddah", country: "SA", lat: 21.680, lng: 39.157, tz: "Asia/Riyadh"},
            "KBL": {name: "Hamid Karzai International Airport", city: "Kabul", country: "AF", lat: 34.566, lng: 69.212, tz: "Asia/Kabul"},
            "KHI": {name: "Jinnah International Airport", city: "Karachi", country: "PK", lat: 24.906, lng: 67.161, tz: "Asia/Karachi"},
            "KIN": {name: "Norman Manley International Airport", city: "Kingston", country: "JM", lat: 17.936, lng: -76.788, tz: "America/Jamaica"},
            "KIX": {name: "Kansai International Airport", city: "Osaka", country: "JP", lat: 34.435, lng: 135.244, tz: "Asia/Tokyo"},
            "KUL": {name: "Kuala Lumpur International Airport", city: "Kuala Lumpur", country: "MY", lat: 2.746, lng: 101.710, tz: "Asia/Kuala_Lumpur"},
            "KWI": {name: "Kuwait International Airport", city: "Kuwait City", country: "KW", lat: 29.227, lng: 47.969, tz: "Asia/Kuwait"},
            "LAS": {name: "Harry Reid International Airport", city: "Las Vegas", country: "US", lat: 36.081, lng: -115.152, tz: "America/Los_Angeles"},
            "LGW": {name: "London Gatwick Airport", city: "London", country: "GB", lat: 51.148, lng: -0.191, tz: "Europe/London"},
            "LIM": {name: "Jorge Ch√°vez International Airport", city: "Lima", country: "PE", lat: -12.022, lng: -77.114, tz: "America/Lima"},
            "LIS": {name: "Lisbon Portela Airport", city: "Lisbon", country: "PT", lat: 38.774, lng: -9.134, tz: "Europe/Lisbon"},
            "MCO": {name: "Orlando International Airport", city: "Orlando", country: "US", lat: 28.429, lng: -81.309, tz: "America/New_York"},
            "MCT": {name: "Muscat International Airport", city: "Muscat", country: "OM", lat: 23.593, lng: 58.284, tz: "Asia/Muscat"},
            "MDW": {name: "Chicago Midway International Airport", city: "Chicago", country: "US", lat: 41.786, lng: -87.752, tz: "America/Chicago"},
            "MLA": {name: "Malta International Airport", city: "Malta", country: "MT", lat: 35.857, lng: 14.478, tz: "Europe/Malta"},
            "MLE": {name: "Velana International Airport", city: "Male", country: "MV", lat: 4.192, lng: 73.529, tz: "Indian/Maldives"},
            "MNL": {name: "Ninoy Aquino International Airport", city: "Manila", country: "PH", lat: 14.509, lng: 121.020, tz: "Asia/Manila"},
            "MSP": {name: "Minneapolis-St Paul International Airport", city: "Minneapolis", country: "US", lat: 44.882, lng: -93.222, tz: "America/Chicago"},
            "MUC": {name: "Munich Airport", city: "Munich", country: "DE", lat: 48.354, lng: 11.786, tz: "Europe/Berlin"},
            "MVD": {name: "Carrasco International Airport", city: "Montevideo", country: "UY", lat: -34.838, lng: -56.031, tz: "America/Montevideo"},
            "NAN": {name: "Nadi International Airport", city: "Nadi", country: "FJ", lat: -17.755, lng: 177.443, tz: "Pacific/Fiji"},
            "PEK": {name: "Beijing Capital International Airport", city: "Beijing", country: "CN", lat: 40.080, lng: 116.585, tz: "Asia/Shanghai"},
            "PVG": {name: "Shanghai Pudong International Airport", city: "Shanghai", country: "CN", lat: 31.144, lng: 121.805, tz: "Asia/Shanghai"},
            "PTY": {name: "Tocumen International Airport", city: "Panama City", country: "PA", lat: 9.071, lng: -79.383, tz: "America/Panama"},
            "UIO": {name: "Mariscal Sucre International Airport", city: "Quito", country: "EC", lat: -0.129, lng: -78.358, tz: "America/Guayaquil"},
            "VIE": {name: "Vienna International Airport", city: "Vienna", country: "AT", lat: 48.110, lng: 16.570, tz: "Europe/Vienna"},
            "WAW": {name: "Warsaw Chopin Airport", city: "Warsaw", country: "PL", lat: 52.166, lng: 20.967, tz: "Europe/Warsaw"},
            "WLG": {name: "Wellington International Airport", city: "Wellington", country: "NZ", lat: -41.327, lng: 174.805, tz: "Pacific/Auckland"},
            "YVR": {name: "Vancouver International Airport", city: "Vancouver", country: "CA", lat: 49.194, lng: -123.184, tz: "America/Vancouver"},
            "ZRH": {name: "Zurich Airport", city: "Zurich", country: "CH", lat: 47.458, lng: 8.548, tz: "Europe/Zurich"}
        };

        // Airport lookup functionality
        async function lookupAirport() {
            const airportCode = document.getElementById('airportCode').value.trim().toUpperCase();
            const resultsDiv = document.getElementById('airportResults');

            if (!airportCode || airportCode.length !== 3) {
                resultsDiv.innerHTML = '<div class="error">Please enter a valid 3-letter airport code.</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">üîç Magicccccccc...</div>';

            try {
                // Check if airport exists in embedded database
                const airport = AIRPORTS_DB[airportCode];
                
                if (!airport) {
                    resultsDiv.innerHTML = '<div class="error">Please find Kenny Wong!!!</div>';
                    return;
                }
                
                // Get weather data from Open-Meteo (free, no API key needed)
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${airport.lat}&longitude=${airport.lng}&current=temperature_2m,weather_code&timezone=auto`
                );
                
                const weatherData = await weatherResponse.json();
                
                // Calculate time difference with HKT (GMT+8)
                const airportTimezone = airport.tz;
                
                // Get current time in airport's timezone
                const now = new Date();
                const airportTime = new Date(now.toLocaleString('en-US', { timeZone: airportTimezone, hour12: false }));
                const hktTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong', hour12: false }));
                
                // Calculate time difference in hours
                const timeDiff = (airportTime.getTime() - hktTime.getTime()) / (1000 * 60 * 60);
                const timeDiffText = timeDiff >= 0 ? `+${timeDiff.toFixed(1)}` : timeDiff.toFixed(1);
                
                // Weather code to description mapping (WMO codes)
                const weatherDescriptions = {
                    0: '‚òÄÔ∏è Clear sky',
                    1: 'üå§Ô∏è Mainly clear',
                    2: '‚õÖ Partly cloudy',
                    3: '‚òÅÔ∏è Overcast',
                    45: 'üå´Ô∏è Foggy',
                    48: 'üå´Ô∏è Depositing rime fog',
                    51: 'üå¶Ô∏è Light drizzle',
                    53: 'üå¶Ô∏è Moderate drizzle',
                    55: 'üåßÔ∏è Dense drizzle',
                    61: 'üåßÔ∏è Slight rain',
                    63: 'üåßÔ∏è Moderate rain',
                    65: 'üåßÔ∏è Heavy rain',
                    71: 'üå®Ô∏è Slight snow',
                    73: 'üå®Ô∏è Moderate snow',
                    75: 'üå®Ô∏è Heavy snow',
                    77: '‚ùÑÔ∏è Snow grains',
                    80: 'üå¶Ô∏è Slight rain showers',
                    81: 'üåßÔ∏è Moderate rain showers',
                    82: 'üåßÔ∏è Violent rain showers',
                    85: 'üå®Ô∏è Slight snow showers',
                    86: 'üå®Ô∏è Heavy snow showers',
                    95: '‚õàÔ∏è Thunderstorm',
                    96: '‚õàÔ∏è Thunderstorm with slight hail',
                    99: '‚õàÔ∏è Thunderstorm with heavy hail'
                };

                const weatherCode = weatherData.current.weather_code;
                const weatherDesc = weatherDescriptions[weatherCode] || 'üå§Ô∏è Unknown';
                const temperature = weatherData.current.temperature_2m;

                // Display results
                let html = `
                    <div class="option">
                        <div class="option-header">
                            <div class="option-title">${airport.name} (${airportCode})</div>
                            <div class="option-badge badge-mtr">${airport.country}</div>
                        </div>
                        <div class="option-details">
                            <div class="time-row">
                                <span class="time-label">üåç Country:</span>
                                <span class="time-value">${airport.country}</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üèôÔ∏è City:</span>
                                <span class="time-value">${airport.city || 'N/A'}</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üïê Local Time:</span>
                                <span class="time-value">${airportTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })} (${airportTime.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })})</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üá≠üá∞ Hong Kong Time:</span>
                                <span class="time-value">${hktTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })} (${hktTime.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })})</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">‚è∞ Time Diff from HKT:</span>
                                <span class="time-value">${timeDiffText} hours</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üå°Ô∏è Temperature:</span>
                                <span class="time-value">${temperature}¬∞C</span>
                            </div>
                            <div class="time-row">
                                <span class="time-label">üå§Ô∏è Weather:</span>
                                <span class="time-value">${weatherDesc}</span>
                            </div>
                        </div>
                    </div>
                `;

                resultsDiv.innerHTML = html;

            } catch (error) {
                console.error('Airport lookup error:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <strong>Error fetching airport data</strong><br>
                        <small>${error.message}</small><br>
                        <small style="margin-top: 8px; display: block;">Currently supporting 160+ major international airports worldwide including JFK, LAX, LHR, HKG, NRT, CDG, DXB, SIN, ICN, SYD, TPE, BKK, IST, DUB, AKL, ACC, ADD, and many more.</small>
                    </div>
                `;
            }
        }

        // Allow Enter key to trigger airport search
        document.getElementById('airportCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupAirport();
            }
        });
    </script>
</body>
</html>
